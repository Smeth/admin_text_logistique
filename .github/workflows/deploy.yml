name: CI/CD Livrango Admin Deployment

on:
  push:
    branches:
      - master

jobs:

  ###############################################
  # 1) BUILD JOB (GitHub Runner)
  ###############################################
  build:
    name: Build Laravel Project
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ---------- PHP ----------
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: bcmath, pdo_mysql, mbstring, zip, tokenizer
          coverage: none

      - name: Install Composer Dependencies
        run: composer install --no-dev --prefer-dist --optimize-autoloader

      - name: Clear Laravel caches
        run: |
          php artisan optimize:clear || true
          rm -rf bootstrap/cache/*.php || true

      # ---------- NODE ----------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install NPM Dependencies
        run: npm ci

      - name: Clean & Build Frontend Assets
        run: |
          rm -rf public/build
          npm run build

      # ---------- ZIP ----------
      - name: Create Deployment Artifact
        run: |
          mkdir -p artifact
          zip -r artifact/build.zip \
            app bootstrap config database public resources routes vendor \
            artisan composer.json composer.lock \
            package.json package-lock.json vite.config.js

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: artifact/build.zip

  ###############################################
  # 2) DEPLOY JOB (SSH)
  ###############################################
  deploy:
    name: Deploy to Production Server
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: build
          path: ./artifact

      - name: Prepare Server Directories
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            PROJECT_DIR="/var/www/livrango/admin"

            echo "ðŸ“ Creating necessary directories..."
            # CrÃ©er les dossiers sans sudo si possible, sinon avec sudo -n (non-interactif)
            mkdir -p "$PROJECT_DIR/tmp" 2>/dev/null || sudo -n mkdir -p "$PROJECT_DIR/tmp" || {
              echo "âš ï¸ Warning: Could not create tmp directory, will try during deployment"
            }
            mkdir -p "$PROJECT_DIR/releases" 2>/dev/null || sudo -n mkdir -p "$PROJECT_DIR/releases" || {
              echo "âš ï¸ Warning: Could not create releases directory, will try during deployment"
            }
            mkdir -p "$PROJECT_DIR/storage/app/public/colis" 2>/dev/null || sudo -n mkdir -p "$PROJECT_DIR/storage/app/public/colis" || true
            mkdir -p "$PROJECT_DIR/storage/logs" 2>/dev/null || sudo -n mkdir -p "$PROJECT_DIR/storage/logs" || true
            mkdir -p "$PROJECT_DIR/storage/framework/cache" 2>/dev/null || sudo -n mkdir -p "$PROJECT_DIR/storage/framework/cache" || true
            mkdir -p "$PROJECT_DIR/storage/framework/sessions" 2>/dev/null || sudo -n mkdir -p "$PROJECT_DIR/storage/framework/sessions" || true
            mkdir -p "$PROJECT_DIR/storage/framework/views" 2>/dev/null || sudo -n mkdir -p "$PROJECT_DIR/storage/framework/views" || true

            echo "ðŸ” Setting initial permissions (if sudo available)..."
            # Essayer sans sudo d'abord, puis avec sudo -n (non-interactif)
            chown -R $USER:www-data "$PROJECT_DIR/tmp" 2>/dev/null || sudo -n chown -R $USER:www-data "$PROJECT_DIR/tmp" 2>/dev/null || true
            chown -R $USER:www-data "$PROJECT_DIR/releases" 2>/dev/null || sudo -n chown -R $USER:www-data "$PROJECT_DIR/releases" 2>/dev/null || true
            chown -R $USER:www-data "$PROJECT_DIR/storage" 2>/dev/null || sudo -n chown -R $USER:www-data "$PROJECT_DIR/storage" 2>/dev/null || true
            chmod -R 775 "$PROJECT_DIR/tmp" 2>/dev/null || sudo -n chmod -R 775 "$PROJECT_DIR/tmp" 2>/dev/null || true
            chmod -R 775 "$PROJECT_DIR/releases" 2>/dev/null || sudo -n chmod -R 775 "$PROJECT_DIR/releases" 2>/dev/null || true
            chmod -R 775 "$PROJECT_DIR/storage" 2>/dev/null || sudo -n chmod -R 775 "$PROJECT_DIR/storage" 2>/dev/null || true

      - name: Upload Artifact to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "./artifact/build.zip"
          target: "/var/www/livrango/admin/tmp"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}

          script: |
            set -e

            PROJECT_DIR="/var/www/livrango/admin"
            RELEASES_DIR="$PROJECT_DIR/releases"
            TMP_DIR="$PROJECT_DIR/tmp"
            ZIP_PATH="$TMP_DIR/build.zip"

            RELEASE_NAME=$(date +%Y%m%d_%H%M%S)
            NEW_RELEASE="$RELEASES_DIR/$RELEASE_NAME"
            PREVIOUS_RELEASE=$(readlink "$PROJECT_DIR/current" || echo "")

            echo "ðŸš€ Deploying release $RELEASE_NAME"

            rollback() {
              echo "âŒ Rollback..."
              if [ -n "$PREVIOUS_RELEASE" ]; then
                rm -rf "$PROJECT_DIR/current"
                ln -sfn "$PREVIOUS_RELEASE" "$PROJECT_DIR/current"
              fi
              exit 1
            }

            trap rollback ERR

            # CrÃ©er les dossiers nÃ©cessaires
            echo "ðŸ“ Creating release directory..."
            mkdir -p "$RELEASES_DIR" 2>/dev/null || sudo -n mkdir -p "$RELEASES_DIR" || {
              echo "âŒ Error: Cannot create releases directory"
              exit 1
            }
            mkdir -p "$NEW_RELEASE"

            # VÃ©rifier que le fichier ZIP existe
            echo "ðŸ” Verifying artifact..."
            if [ ! -f "$ZIP_PATH" ]; then
              echo "âŒ Error: $ZIP_PATH not found!"
              echo "ðŸ“‚ Contents of $TMP_DIR:"
              ls -la "$TMP_DIR" || echo "Directory does not exist"
              exit 1
            fi

            echo "ðŸ“¦ Extracting artifact..."
            unzip -q "$ZIP_PATH" -d "$NEW_RELEASE"

            echo "ðŸ”— Linking shared storage..."
            rm -rf "$NEW_RELEASE/storage"
            ln -s "$PROJECT_DIR/storage" "$NEW_RELEASE/storage"

            echo "ðŸ” Setting permissions..."
            # Essayer sans sudo d'abord, puis avec sudo -n (non-interactif)
            chown -R $USER:www-data "$NEW_RELEASE" 2>/dev/null || sudo -n chown -R $USER:www-data "$NEW_RELEASE" 2>/dev/null || true
            chmod -R 755 "$NEW_RELEASE" 2>/dev/null || sudo -n chmod -R 755 "$NEW_RELEASE" 2>/dev/null || true
            chmod -R 775 "$NEW_RELEASE/storage" "$NEW_RELEASE/bootstrap/cache" 2>/dev/null || sudo -n chmod -R 775 "$NEW_RELEASE/storage" "$NEW_RELEASE/bootstrap/cache" 2>/dev/null || true

            echo "ðŸ”„ Switching symlink..."
            # Supprimer l'ancien lien/dossier current s'il existe
            if [ -e "$PROJECT_DIR/current" ]; then
              rm -rf "$PROJECT_DIR/current"
            fi
            ln -sfn "$NEW_RELEASE" "$PROJECT_DIR/current"

            # VÃ©rifier que le lien symbolique est correct
            if [ ! -L "$PROJECT_DIR/current" ]; then
              echo "âŒ Error: Failed to create symlink!"
              exit 1
            fi

            echo "âš™ï¸ Laravel optimizations..."
            cd "$PROJECT_DIR/current"

            # CrÃ©er le lien symbolique public/storage
            echo "ðŸ”— Creating storage symlink..."
            rm -f public/storage
            php artisan storage:link || {
              # Fallback si storage:link Ã©choue
              ln -s ../../storage/app/public public/storage || true
            }

            # VÃ©rifier que le lien existe
            if [ ! -L "public/storage" ]; then
              echo "âš ï¸ Warning: public/storage symlink not created, trying manual method..."
              ln -sfn "$PROJECT_DIR/storage/app/public" public/storage
            fi

            php artisan optimize:clear
            php artisan view:clear
            php artisan config:cache
            php artisan route:cache

            echo "ðŸ—„ï¸ Database migrations..."
            php artisan migrate --force

            echo "ðŸŒ± Seeds..."
            php artisan db:seed --force || true

            # Finaliser les permissions pour storage
            echo "ðŸ” Finalizing storage permissions..."
            chown -R $USER:www-data "$PROJECT_DIR/storage" 2>/dev/null || sudo -n chown -R $USER:www-data "$PROJECT_DIR/storage" 2>/dev/null || true
            chmod -R 775 "$PROJECT_DIR/storage/app/public" 2>/dev/null || sudo -n chmod -R 775 "$PROJECT_DIR/storage/app/public" 2>/dev/null || true
            chmod -R 775 "$PROJECT_DIR/storage/app/public/colis" 2>/dev/null || sudo -n chmod -R 775 "$PROJECT_DIR/storage/app/public/colis" 2>/dev/null || true

            # Nettoyer les anciennes releases (garder les 5 derniÃ¨res)
            echo "ðŸ§¹ Cleaning old releases..."
            cd "$RELEASES_DIR"
            ls -t | tail -n +6 | xargs -r rm -rf || true

            echo "âœ… DEPLOYMENT SUCCESS"
