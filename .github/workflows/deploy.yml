name: CI/CD Laravel Deployment

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: bcmath, pdo_mysql, zip, mbstring
        coverage: none

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: package-lock.json

    - name: Cache Composer dependencies
      uses: actions/cache@v4
      with:
        path: vendor
        key: ${{ runner.os }}-composer-${{ hashFiles('composer.lock') }}
        restore-keys: ${{ runner.os }}-composer-

    - name: Install PHP Dependencies
      run: composer install --no-dev --prefer-dist

    - name: Install NPM Dependencies
      run: npm ci

    - name: Build Assets
      run: npm run build

    - name: Run Tests (Optional)
      run: php artisan test || echo "Tests skipped"
      continue-on-error: true

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: SSH Deploy Command
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.AWS_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -e

          PROJECT_DIR="/var/www/livrango/admin"

          echo "ğŸ“ Navigating to project directory"
          cd $PROJECT_DIR

          echo "ğŸ” Marking directory as safe for Git"
          git config --global --add safe.directory $PROJECT_DIR

          echo "â¬‡ï¸ Pulling latest code"
          git pull origin master

          echo "ğŸ“¦ Installing PHP dependencies"
          composer install --no-dev --prefer-dist --optimize-autoloader

          echo "ğŸ“¦ Installing NPM dependencies"
          npm ci --production=false

          echo "ğŸ—ï¸ Building frontend"
          npm run build

          echo "ğŸ”— Storage link"
          php artisan storage:link || true

          echo "ğŸ—ƒï¸ Running migrations"
          php artisan migrate --force

          echo "ğŸ§¹ Clearing caches"
          php artisan optimize:clear

          echo "âš¡ Optimizing Laravel"
          php artisan optimize

          echo "ğŸ” Restarting PHP-FPM"
          sudo service php8.3-fpm restart

          echo "ğŸš€ Deployment successful!"
