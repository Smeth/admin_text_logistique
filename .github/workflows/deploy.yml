# .github/workflows/deploy.yml

name: CI/CD Laravel Deployment

on:
  push:
    branches:
      - master

jobs:
  # 1. Continuous Integration (Test & Build)
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: bcmath, pdo_mysql, zip, mbstring
        coverage: none

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: gestAdmin/package-lock.json

    - name: Cache Composer dependencies
      uses: actions/cache@v4
      with:
        path: gestAdmin/vendor
        key: ${{ runner.os }}-composer-${{ hashFiles('gestAdmin/composer.lock') }}
        restore-keys: ${{ runner.os }}-composer-

    - name: Install PHP Dependencies
      working-directory: gestAdmin
      run: composer install --no-dev --prefer-dist

    - name: Install NPM Dependencies
      working-directory: gestAdmin
      run: npm ci

    - name: Build Assets
      working-directory: gestAdmin
      run: npm run build

    - name: Run Tests (Optional)
      working-directory: gestAdmin
      run: php artisan test || echo "Tests skipped"
      continue-on-error: true

  # 2. Continuous Delivery (Deployment via SSH)
  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: SSH Deploy Command
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.AWS_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -e

          # Variables
          PROJECT_DIR="/var/www/livrango/admin"
          BACKUP_DIR="/var/www/backups"

          echo "üîç D√©placement dans le dossier du projet..."
          cd $PROJECT_DIR

          echo "üíæ Cr√©ation d'un backup de la base de donn√©es..."
          mkdir -p $BACKUP_DIR
          BACKUP_FILE="$BACKUP_DIR/backup_$(date +%Y%m%d_%H%M%S).sql"
          if [ -n "${{ secrets.DB_USER }}" ] && [ -n "${{ secrets.DB_PASSWORD }}" ] && [ -n "${{ secrets.DB_NAME }}" ]; then
            mysqldump -u ${{ secrets.DB_USER }} -p${{ secrets.DB_PASSWORD }} ${{ secrets.DB_NAME }} > $BACKUP_FILE 2>/dev/null || echo "‚ö†Ô∏è Backup √©chou√©, continuation..."
            if [ -f $BACKUP_FILE ] && [ -s $BACKUP_FILE ]; then
              echo "‚úÖ Backup cr√©√©: $BACKUP_FILE"
            else
              echo "‚ö†Ô∏è Backup vide ou √©chou√©, continuation..."
            fi
          else
            echo "‚ö†Ô∏è Variables DB non configur√©es, backup ignor√©"
          fi

          echo "‚öôÔ∏è  Autorisation Git safe.directory..."
          git config --global --add safe.directory $PROJECT_DIR

          echo "‚¨áÔ∏è  Pull du dernier code..."
          git pull origin master

          echo "üì¶ Installation des d√©pendances Laravel..."
          composer install --no-dev --prefer-dist --optimize-autoloader

          echo "üì¶ Installation des d√©pendances NPM..."
          npm ci --production=false

          echo "üèóÔ∏è  Build des assets frontend..."
          npm run build

          echo "üîó V√©rification/Cr√©ation du symlink storage..."
          php artisan storage:link || echo "Symlink d√©j√† existant"

          echo "üìù V√©rification du fichier .env..."
          if [ ! -f .env ]; then
            echo "‚ö†Ô∏è  Fichier .env manquant, copie depuis .env.example..."
            cp .env.example .env 2>/dev/null || echo "‚ö†Ô∏è  .env.example non trouv√©"
            echo "‚ö†Ô∏è  ATTENTION: Configurez le fichier .env manuellement !"
          else
            echo "‚úÖ Fichier .env pr√©sent"
          fi

          echo "üîê Gestion des permissions..."
          sudo chown -R www-data:www-data storage bootstrap/cache 2>/dev/null || echo "‚ö†Ô∏è  √âchec changement propri√©taire"
          sudo chmod -R 775 storage bootstrap/cache 2>/dev/null || echo "‚ö†Ô∏è  √âchec changement permissions"

          echo "üóÉÔ∏è  Ex√©cution des migrations..."
          php artisan migrate --force

          echo "üßπ Nettoyage complet du cache Laravel..."
          php artisan optimize:clear
          php artisan cache:clear
          php artisan config:clear
          php artisan route:clear
          php artisan view:clear

          echo "‚ö° Optimisation Laravel..."
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          php artisan optimize

          echo "üîÑ Red√©marrage des queues (si actives)..."
          php artisan queue:restart || echo "Queues non configur√©es"

          echo "üîÅ Red√©marrage de PHP-FPM..."
          sudo service php8.3-fpm restart

          echo "‚úÖ V√©rification de l'application..."
          sleep 3
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost 2>/dev/null || echo "000")
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ] || [ "$HTTP_CODE" = "301" ]; then
            echo "‚úÖ Application accessible (HTTP $HTTP_CODE)"
          elif [ "$HTTP_CODE" = "000" ]; then
            echo "‚ö†Ô∏è  Impossible de v√©rifier (curl non disponible ou serveur non accessible)"
          else
            echo "‚ö†Ô∏è  Code HTTP: $HTTP_CODE - V√©rifiez manuellement"
          fi

          echo "üöÄ D√©ploiement termin√© avec succ√®s !"
