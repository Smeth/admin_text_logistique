name: CI/CD Livrango Admin Deployment

on:
  push:
    branches:
      - master

jobs:

  ###############################################
  # 1) BUILD JOB (GitHub Runner)
  ###############################################
  build:
    name: Build Laravel Project
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ---------- PHP ----------
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: bcmath, pdo_mysql, mbstring, zip, tokenizer
          coverage: none

      - name: Install Composer Dependencies
        run: composer install --no-dev --prefer-dist --optimize-autoloader

      - name: Clear Laravel caches
        run: |
          php artisan optimize:clear || true
          rm -rf bootstrap/cache/*.php || true

      # ---------- NODE ----------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install NPM Dependencies
        run: npm ci

      - name: Clean & Build Frontend Assets
        run: |
          rm -rf public/build
          npm run build

      # ---------- ZIP ----------
      - name: Create Deployment Artifact
        run: |
          mkdir -p artifact
          zip -r artifact/build.zip \
            app bootstrap config database public resources routes vendor \
            artisan composer.json composer.lock \
            package.json package-lock.json vite.config.js

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: artifact/build.zip

  ###############################################
  # 2) DEPLOY JOB (SSH)
  ###############################################
  deploy:
    name: Deploy to Production Server
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: build
          path: ./artifact

      - name: Upload Artifact to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "artifact/build.zip"
          target: "/var/www/livrango/admin/tmp"
          strip_components: 1 # <--- CORRECTION ICI (EnlÃ¨ve le dossier 'artifact/')

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            PROJECT_DIR="/var/www/livrango/admin"
            RELEASES_DIR="$PROJECT_DIR/releases"
            TMP_DIR="$PROJECT_DIR/tmp"
            ZIP_PATH="$TMP_DIR/build.zip"

            RELEASE_NAME=$(date +%Y%m%d_%H%M%S)
            NEW_RELEASE="$RELEASES_DIR/$RELEASE_NAME"
            PREVIOUS_RELEASE=$(readlink "$PROJECT_DIR/current" || echo "")

            echo "ðŸš€ Deploying release $RELEASE_NAME"

            rollback() {
              echo "âŒ Rollback..."
              if [ -n "$PREVIOUS_RELEASE" ]; then
                ln -sfn "$PREVIOUS_RELEASE" "$PROJECT_DIR/current"
              fi
              exit 1
            }

            trap rollback ERR

            mkdir -p "$NEW_RELEASE"

            echo "ðŸ“¦ Extracting artifact..."
            # Le fichier est maintenant bien Ã  la racine de tmp
            unzip -q "$ZIP_PATH" -d "$NEW_RELEASE"

            echo "ðŸ”— Linking shared storage & .env..."
            rm -rf "$NEW_RELEASE/storage"
            ln -s "$PROJECT_DIR/storage" "$NEW_RELEASE/storage"

            # AJOUT CRITIQUE : Lien vers le fichier .env
            # Assurez-vous que /var/www/livrango/admin/.env existe sur le serveur
            ln -s "$PROJECT_DIR/.env" "$NEW_RELEASE/.env"

            echo "ðŸ” Permissions..."
            sudo chown -R www-data:www-data "$NEW_RELEASE"
            sudo chmod -R 775 "$NEW_RELEASE/storage" "$NEW_RELEASE/bootstrap/cache"

            echo "ðŸ”„ Switching symlink..."
            ln -sfn "$NEW_RELEASE" "$PROJECT_DIR/current"

            echo "âš™ï¸ Laravel optimizations..."
            cd "$PROJECT_DIR/current"
            php artisan optimize:clear
            php artisan view:clear
            php artisan config:cache
            php artisan route:cache

            echo "ðŸ—„ï¸ Database migrations..."
            php artisan migrate --force

            echo "ðŸŒ± Seeds..."
            php artisan db:seed --force || true

            echo "ðŸ§¹ Cleaning up..."
            rm -f "$ZIP_PATH"

            echo "âœ… DEPLOYMENT SUCCESS"
